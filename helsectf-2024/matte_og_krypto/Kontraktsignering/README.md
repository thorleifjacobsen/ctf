# Kontraktsignering
460
Signaturtjenesten 2OpphøydIe signerer alle dine meldinger, bortsett fra den superviktige kontrakten.

Alle som har riktig signatur på kontrakten får flagget!

from pwn import *
io = remote("helsectf2024-2da207d37b091b1b4dff-kontraktsignering.chals.io", 443, ssl=True)
io.interactive()

[⬇️ solve.py](./soruce.py)

# Writeup

For my self I write up all the variables used in RSA. I never remember them so I have to look them up every time.

```python
# RSA Parameters
e = # Public exponent
N = # Modulus
d = # Private exponent
p = # First prime
q = # Second prime
m = # Message integer
s = # Signature integer

# For blinding
r = # Random value integer
m_blind = # Blinded message integer
s_blind = # Blinded signature integer

# How to get message back to text and reverse
message_cleartext = long_to_bytes(m)
m = bytes_to_long(message_cleartext)
```

Based on what we can read from [source.py](./source.py) we can see that this is a RSA signing service. We do not know the private key as this is hosted on the server and generated by `getPrime`. Here I tried a lot of things but finally I got something that seemd realistic from ChatGPT of everything. It mentioned `Existential Forgery Attack` and `Blinding` which I had never heard about before. 

Basically you use a random number (in my case `r`) to blind the message you want to sign. Then you send the blinded message to the signing service and get the blinded signature back. Then you unblind the signature and send it back to the signing service. If the signature is correct you will get the flag.

This [Udacity video](https://www.youtube.com/watch?v=CcB9nH78Ths&list=PLAwxTw4SYaPnCeih6BPvJ5GdqqThGcWlX&index=319) shows how you can blind a message. 

The random value should be a number between 2 and N-1. N is the modulus. The modulus is the product of two prime numbers. The modulus is public and the two prime numbers are private.

The formula for blinding a message is: `m_blind = (m * r^e) % N`

The formula for unblinding a signature is: `s = (s_blind * inverse(r, N)) % N`

So lets make a script doing this:

```python
from pwn import *
from Crypto.Util.number import bytes_to_long, inverse

context.log_level = "warn"

# The original contract
contract = b"Dette er en superviktig kontrakt for veeldig viktige ting med store ord og uforstaaelige kruseduller."
contract_long = bytes_to_long(contract)

# RSA Parameters
e = 0x10001
N = "Will be received upon connection"
r = 10 # Just a random value

# Connection:
io = remote("helsectf2024-2da207d37b091b1b4dff-kontraktsignering.chals.io", 443, ssl=True)
io.recvuntil(b"N=")
N = int(io.recvuntil(b"\n", drop = True).decode())
io.recvuntil(b">")
io.sendline(b"sign")
io.recvuntil(b"message=")
# Blind the message so the server cannot see what it contains
m_blind = (contract_long * pow(r, e)) % N
io.sendline(hex(m_blind)[2:].encode())
io.recvuntil(b"sign= ")
# Receive the signed blind message
s_blind = int(io.recvuntil(b"\n", drop = True).decode(), 16)
# Unblind the signed message
s = (s_blind * inverse(r, N)) % N
# Now s is the signed contract which we can verify
s_hex = hex(s)[2:]
io.sendline(b"verify")
io.recvuntil(b"signature=")
io.sendline(s_hex.encode())
print(io.recvall(timeout = 2).decode())
io.close()
```

# https://www.youtube.com/watch?v=2-sLbNHKhz8&list=PLAwxTw4SYaPnCeih6BPvJ5GdqqThGcWlX&index=318











Signaturtjenesten 2OpphøydIe signerer alle dine meldinger, bortsett fra den superviktige kontrakten:

Dette er en superviktig kontrakt for veeldig viktige ting med store ord og uforstaaelige kruseduller.

N=24816981230454031201960986951112466375976479554093290030997032525453926805669463579991088110882649698147312102491760631956468809122898221164436904836076065406805523960380238682768210295361201960517877746956493062799859133287675625319280781162154883466959151545605972389278072629412703222543325603187736944357833172295791755788224275541105187254361691898817927123802688280758531412586089541875269240746740259955122781851293213188199205326355114793932769846766544152478862000485208182274742549952052528174833204908772459398118222339529439546646699381528657392427784283388200037134252146913397515917205280507328854386419
> sign
message=b99d92c25b9f19a750990cec13453aedd18f7cc5430a7964cb3e8f1c3b37057ce87a9ae41e1dd1312e4f941d5a1c936f7a1006e81a38b13462dd1b0db52f41876a462faa0efd702e5c7ace408bb5f12c214d4960ad7c432b0f622bd623b358b506b1b99cbb2ccfc72e6e238fa49384c6ddedc854788991a76d49c640aa859ef22b2d05413f5b7783e53c9736e6a4f1761bc9d371e84d98438e0bc05dd4ccf0e51e680f535c29c57dbf6462faa22b26544033b41cf9de2e1011768f2b1b468db01adf12bbca31fbcf782382f7e8004965956bb0d34fb3ff1b936d9067edae9192a3d36d115ef73e69beffbe27ff815d8d6c00ee0e219790ebbe9f52adce4cbac1
derre va itj kontrakten, så da ska du få en signatur:
sign= 33524032f68e1b9d575061c01dabe74df13f01657c9390f9235634df8c95927a14c1bedb4a946fe1f86027b80d80c151ee363ef8d73627549e4ff5307c152d3e2cfbd42d6e92f86c0c9583837e7bf2f40e45dabb4e6cf8e1d5ed32a46b9d1b59ee03bfe7843490befd0b773b41ebadb6f136779c19d2b07bd9a91c0b20d1fde78d9b2d0746d509953dbdd1e2f0c129548c174850d329c141430bc9b97e99c5ac87f15f0add79f926d17759a589f309786541476fba0d6df3387f69f7430e252d478afe5c02b6ca4b55458a8fd7973b36e45e0ea97a30e7dd3815b4484cf0bb58ab0b5000b90663daced7bb5dfdb2d5bc883a901820a763f2e1ed92a7234c24e2
> verify
signature=971df61cfc2e7815a2c17d12d849265f9c30d7a6e477653029d05ce9b6c998f27fa20b5eb2cf9430a252e9ab9751c919ea87269c2aa47a6b6360156158f8e4857197154b77628dcf23052a56f54eb1f2c730ded562ccd1bb9e4237dc3ff651066736cc8b6268b776a0d2e6453b92ed4b791cd976d3d6c3d2649cdbd3f20cf996b2e830b3266cbaccb4164e392ebd39c533ae5f0aafb1d1142c7e15ef9b67a5a4e8bf9e6e388505b634e5f2699d9180f3b60dbb733a6a6e36af7480c2af1758870b7522856b2396fce0994f1f6b8629c1e2c47df5d10e08080aee91201302bbb34322e846eff00fbcc29434e8dd244c33f5f30df2b532077f2cdefda6ebf2a33d
ja, herre e riktig signatur ja, no va du flink!
flag= helsectf{naar_man_jobber_med_krypto_b0r_man_vite_hva_man_gj0r}
[*] Got EOF while reading in interactive